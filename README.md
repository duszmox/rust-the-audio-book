# Rust The Audio Book

Overview

- Purpose: Convert the Rust Book chapters in `book/src/*.md` into cleaned, narrated audio files.
- How: For each chapter, the app:
  - Expands mdBook include directives so the Markdown contains real code/text:
    - `{{#include path}}` → inlines file contents.
    - `{{#rustdoc_include path[:tag]}}` → inlines the file (optionally only the region between `// ANCHOR: tag` and `// ANCHOR_END: tag`). Anchor comment lines are removed.
  - Replaces every fenced code block (`...`) with a short, listener‑friendly summary generated by Gemini.
  - Sanitizes the chapter text for TTS (removes links, headers/lists, HTML, code fences, backticks, some custom tags, and normalizes `scr/` → `source/`).
  - Splits long text into ≤ 3000‑character chunks at paragraph boundaries, then performs TTS for each chunk.
  - Merges all audio chunks back into a single playable audio file per chapter (WAV header rewrite for PCM/LINEAR16; MP3 concatenation when applicable).

Requirements

- Rust (stable toolchain) and Cargo
- Internet access
- [Google Gemini API key](https://aistudio.google.com/apikey) with access to:
  - `gemini-2.5-flash` (text summaries)
  - `gemini-2.5-pro-preview-tts` (text‑to‑speech)

Setup

1. Provide your Gemini API key either via environment or CLI:

- Option A (.env):

```env
GEMINI_API_KEY=your_api_key_here
```

- Option B (CLI): pass `--api-key <KEY>` when running.

2. Build the project:

```sh
cargo build --release
```

Usage

- Process all chapters in `book/src/` (default voice: Zephyr):

```sh
cargo run --release
```

- Process a single chapter (choose a voice):

```sh
cargo run --release -- -v Leda book/src/ch01-02-hello-world.md
```

- Pass API key via CLI instead of .env:

```sh
cargo run --release -- --api-key YOUR_KEY --voice Zephyr book/src/ch06-02-match.md
```

- List available voices:

```sh
cargo run --release -- --list-voices
```

- Show help:

```sh
cargo run --release -- --help
```

CLI options

- `-v, --voice <NAME>`: Choose a TTS voice (default: `Zephyr`).
- `-k, --api-key <KEY>`: Provide Gemini API key (overrides `GEMINI_API_KEY`).
- `--list-voices`: Print available voice names with short descriptions.
- `-h, --help`: Show usage help and exit.

Outputs

- Audio files are written to the `audio/` directory.
- File name: `audio/<chapter>.<ext>` where `<chapter>` is the markdown file stem and `<ext>` is based on the returned/normalized MIME type:
  - LINEAR16/PCM → wrapped to proper WAV (`.wav`)
  - MP3 → `.mp3`
  - OGG → `.ogg`
  - Unknown → `.bin` (fallback)

What the app does

- Include expansion:

  - Recognizes mdBook directives and inlines their targets before any summarization:
    - `{{#include relative/path}}` inlines the whole file.
    - `{{#rustdoc_include relative/path[:region]}}` inlines either the whole file or only the region between `// ANCHOR: region` and `// ANCHOR_END: region`.
  - Anchor comment lines are stripped from the output.
  - Paths are resolved relative to the Markdown file location.

- Code block summarization: Finds triple‑backtick blocks and replaces their content by calling Gemini `generateContent` on `gemini-2.5-flash` with a short, non‑jargony summary prompt.
- Text sanitization for TTS:

  - Removes Markdown links: `[text](url)` → `text`, `[text][id]` → `text`, drops autolinks `<https://...>` and bare URLs.
  - Handles images for audio friendliness:
    - Markdown images: `![alt](url)` and `![alt][id]` become just `alt`.
    - HTML images: `<img ... alt="...">` becomes the `alt` text; images without an `alt` are removed.
  - Removes reference link definitions like `[id]: https://...`.
  - Strips headings (`#`), list bullets (`- * +`), numbered lists (`1.`, `1)`), and leading blockquote markers (`>`).
  - Drops lines starting with `<Listing` / `</Listing>` and code fence lines (```).
  - Removes inline HTML tags/comments and backticks.
  - Replaces any `scr/` with `source/`.
  - Collapses excess blank lines to keep narration flowing.

- Chunking: Splits the sanitized text into ≤ 3000 characters, prioritizing paragraph boundaries; falls back to sentence end.
- TTS:

  - Calls `gemini-2.5-pro-preview-tts:generateContent` requesting audio.
  - Supports choosing among several prebuilt voices (see "Available voices").
  - If audio is returned as raw LINEAR16/PCM, wraps it into a valid WAV container for compatibility.
  - Logs timestamps and durations for each TTS chunk.

- Merging:

  - WAV/PCM: Parses headers, validates matching format, concatenates data, and writes a single correct WAV.
  - MP3: Concatenates frame streams (works in most players).

Handling rate limits and errors

- Automatic retries on 429/5xx with exponential backoff and respect for `Retry-After` when provided (up to 6 attempts).
- Clear error messages if a call ultimately fails.

Examples

```sh
cargo run --release -- book/src/ch02-00-guessing-game-tutorial.md

# Output sample
# [1 / 1] Starting book/src/ch02-00-guessing-game-tutorial.md
# Reading book/src/ch02-00-guessing-game-tutorial.md: 39813 characters
# Summarized 12 code block(s) in book/src/ch02-00-guessing-game-tutorial.md
# Sanitized text for TTS (links/headers/lists/html/code fences): 35600 -> 34210 chars
# Chunked content into 12 piece(s) (<=3000 chars each)
# 2025-09-06 17:05:00.123 | TTS part 01: 2984 chars...
# 2025-09-06 17:05:02.456 | TTS part 01: mime=audio/wav, 245678 bytes, took 2.333s
# ...
# Processed book/src/ch02-00-guessing-game-tutorial.md => audio/ch02-00-guessing-game-tutorial.wav (3123456 bytes from 12 chunks)
```

Sample audio

- Example output for [Chapter 1.2 (Hello World)](./sample/ch01-02-hello-world.wav)

Notes and limitations

The transformed markdown is not written back to disk; it’s used only for TTS.

Only triple‑backtick code fences are summarized; indented code blocks are ignored.

Include anchors must use Rust‑style comments (`// ANCHOR: name` and `// ANCHOR_END: name`) as used by the Rust Book listings. Other comment syntaxes are not supported.

Streaming (`streamGenerateContent`) is not used; if your account only allows streaming for TTS, extend the client to parse SSE and assemble audio.

Project layout

- `src/main.rs` — CLI entry; orchestrates scanning, sanitizing, TTS, merging.
- `src/audio.rs` — Audio helpers (MIME/extension, MP3/WAV merge, PCM→WAV wrap).
- `src/markdown.rs` — Include expansion, code‑block summarization, sanitization, chunking.
- `src/tts.rs` — Gemini client (summaries + TTS with retries). Exposes `AVAILABLE_VOICES`.
- `src/util.rs` — Small utilities (timestamps, etc.).
- `Cargo.toml` — Dependencies (`reqwest`, `tokio`, `serde`, `dotenvy`, `regex`, `chrono`, etc.).
- `.env` — Optionally contains `GEMINI_API_KEY` (if not using `--api-key`).
- `audio/` — Output directory for generated audio files.

Todo:

- [ ] File / Paragraph for integrated experience with the mdbook version
- [ ] Audio file hosting
- [ ] Multi provider support
- [ ] Offline TTS (probably won't be on the level of online hosted one)
